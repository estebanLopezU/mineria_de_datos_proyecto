<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Optimizador de PC</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/animations.js') }}"></script>
</head>
<body>
    <div class="container">
        <h1>Dashboard de Rendimiento del Sistema</h1>
        <p>Monitoreo en tiempo real de los recursos del sistema</p>

        <div class="dashboard-grid">
            <!-- CPU Chart -->
            <div class="chart-card">
                <h3>CPU</h3>
                <div class="chart-container">
                    <canvas id="cpuChart"></canvas>
                </div>
                <div class="stats">
                    <span id="cpuPercent">0%</span>
                    <span id="cpuFreq">0 GHz</span>
                </div>
            </div>

            <!-- Memory Chart -->
            <div class="chart-card">
                <h3>Memoria RAM</h3>
                <div class="chart-container">
                    <canvas id="memoryChart"></canvas>
                </div>
                <div class="stats">
                    <span id="memoryUsed">0 GB</span> / <span id="memoryTotal">0 GB</span>
                </div>
            </div>

            <!-- Disk Chart -->
            <div class="chart-card">
                <h3>Disco Duro</h3>
                <div class="chart-container">
                    <canvas id="diskChart"></canvas>
                </div>
                <div class="stats">
                    <span id="diskUsed">0 GB</span> / <span id="diskTotal">0 GB</span>
                </div>
            </div>

            <!-- Network Chart -->
            <div class="chart-card">
                <h3>Red</h3>
                <div class="chart-container">
                    <canvas id="networkChart"></canvas>
                </div>
                <div class="stats">
                    <span id="netSent">0 MB</span> enviado<br>
                    <span id="netRecv">0 MB</span> recibido
                </div>
            </div>
        </div>

        <div class="system-info">
            <h3>Informaci√≥n del Sistema</h3>
            <div class="info-grid">
                <div class="info-item">
                    <strong>Procesos Activos:</strong> <span id="processCount">0</span>
                </div>
                <div class="info-item">
                    <strong>Tiempo de Actividad:</strong> <span id="uptime">0</span>
                </div>
                <div class="info-item">
                    <strong>Versi√≥n de Python:</strong> <span id="pythonVersion">-</span>
                </div>
                <div class="info-item">
                    <strong>Sistema Operativo:</strong> <span id="osVersion">-</span>
                </div>
            </div>
        </div>

        <!-- AI Assistant Section -->
        <div class="ai-assistant">
            <h3>ü§ñ Asistente IA - OptiBot</h3>
            <div class="ai-chat-container">
                <div class="ai-recommendations" id="aiRecommendations">
                    <div class="ai-message ai-bot">
                        <div class="ai-avatar">ü§ñ</div>
                        <div class="ai-content">
                            <strong>OptiBot:</strong> Analizando tu sistema... Espera las recomendaciones inteligentes.
                        </div>
                    </div>
                </div>
                <div class="ai-chat-input">
                    <input type="text" id="aiQuestion" placeholder="Preg√∫ntame sobre tu PC o el rendimiento..." />
                    <button onclick="askAI()">Preguntar</button>
                </div>
            </div>
        </div>

        <div class="dashboard-actions">
            <a href="/" class="btn-secondary">Volver al Optimizador</a>
            <button onclick="resetCharts()" class="btn-secondary">Reiniciar Gr√°ficos</button>
        </div>
    </div>

    <script>
        // Chart.js configurations
        let cpuChart, memoryChart, diskChart, networkChart;
        let cpuData = [], memoryData = [], diskData = [], networkData = [];
        const maxDataPoints = 20;

        // Initialize charts
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuart'
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#ecf0f1'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#ecf0f1'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#ecf0f1'
                        }
                    }
                }
            };

            // CPU Chart
            cpuChart = new Chart(document.getElementById('cpuChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU %',
                        data: cpuData,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            max: 100
                        }
                    }
                }
            });

            // Memory Chart
            memoryChart = new Chart(document.getElementById('memoryChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Usado', 'Libre'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#e74c3c', '#27ae60'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ecf0f1'
                            }
                        }
                    }
                }
            });

            // Disk Chart
            diskChart = new Chart(document.getElementById('diskChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Usado', 'Libre'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#f39c12', '#9b59b6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ecf0f1'
                            }
                        }
                    }
                }
            });

            // Network Chart
            networkChart = new Chart(document.getElementById('networkChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Enviado (MB)',
                        data: [],
                        borderColor: '#e67e22',
                        backgroundColor: 'rgba(230, 126, 34, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Recibido (MB)',
                        data: [],
                        borderColor: '#1abc9c',
                        backgroundColor: 'rgba(26, 188, 156, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });
        }

        // Update charts with new data
        function updateCharts(data) {
            const timestamp = new Date(data.timestamp * 1000).toLocaleTimeString();

            // CPU
            cpuData.push(data.cpu.percent);
            if (cpuData.length > maxDataPoints) cpuData.shift();
            cpuChart.data.labels = Array.from({length: cpuData.length}, (_, i) => i);
            cpuChart.data.datasets[0].data = cpuData;
            cpuChart.update();

            document.getElementById('cpuPercent').textContent = data.cpu.percent.toFixed(1) + '%';
            document.getElementById('cpuFreq').textContent = (data.cpu.freq_current / 1000).toFixed(2) + ' GHz';

            // Memory
            memoryChart.data.datasets[0].data = [data.memory.percent, 100 - data.memory.percent];
            memoryChart.update();

            document.getElementById('memoryUsed').textContent = data.memory.used + ' GB';
            document.getElementById('memoryTotal').textContent = data.memory.total + ' GB';

            // Disk
            diskChart.data.datasets[0].data = [data.disk.percent, 100 - data.disk.percent];
            diskChart.update();

            document.getElementById('diskUsed').textContent = data.disk.used + ' GB';
            document.getElementById('diskTotal').textContent = data.disk.total + ' GB';

            // Network
            if (networkData.length === 0) {
                networkData.push({sent: data.network.sent, recv: data.network.recv});
            } else {
                networkData.push({
                    sent: data.network.sent - networkData[networkData.length - 1].sent,
                    recv: data.network.recv - networkData[networkData.length - 1].recv
                });
            }
            if (networkData.length > maxDataPoints) networkData.shift();

            networkChart.data.labels = Array.from({length: networkData.length}, (_, i) => i);
            networkChart.data.datasets[0].data = networkData.map(d => d.sent);
            networkChart.data.datasets[1].data = networkData.map(d => d.recv);
            networkChart.update();

            document.getElementById('netSent').textContent = data.network.sent + ' MB';
            document.getElementById('netRecv').textContent = data.network.recv + ' MB';

            // System info
            document.getElementById('processCount').textContent = data.processes;
        }

        // Fetch system stats
        async function fetchSystemStats() {
            try {
                const response = await fetch('/api/system_stats');
                const data = await response.json();
                updateCharts(data);
            } catch (error) {
                console.error('Error fetching system stats:', error);
            }
        }

        // Reset charts
        function resetCharts() {
            cpuData.length = 0;
            memoryData.length = 0;
            diskData.length = 0;
            networkData.length = 0;

            cpuChart.data.labels = [];
            cpuChart.data.datasets[0].data = [];
            cpuChart.update();

            memoryChart.data.datasets[0].data = [0, 100];
            memoryChart.update();

            diskChart.data.datasets[0].data = [0, 100];
            diskChart.update();

            networkChart.data.labels = [];
            networkChart.data.datasets[0].data = [];
            networkChart.data.datasets[1].data = [];
            networkChart.update();
        }

        // AI Assistant Variables
        let currentStats = null;
        let aiMessageCount = 0;

        // AI Response function
        function generateAIResponse(question, stats) {
            const q = question.toLowerCase().trim();

            // An√°lisis inteligente basado en estad√≠sticas
            let response = '';

            if (q.includes('cpu') || q.includes('procesador')) {
                if (stats.cpu.percent > 80) {
                    response = `‚ö†Ô∏è Tu CPU est√° al ${stats.cpu.percent.toFixed(1)}%, lo cual es alto. Te recomiendo cerrar programas innecesarios y ejecutar la optimizaci√≥n de procesos.`;
                } else if (stats.cpu.percent > 50) {
                    response = `üìä Tu CPU est√° al ${stats.cpu.percent.toFixed(1)}%, funcionando normalmente. Si notas lentitud, considera limpiar archivos temporales.`;
                } else {
                    response = `‚úÖ Tu CPU est√° funcionando √≥ptimamente al ${stats.cpu.percent.toFixed(1)}%. ¬°Excelente rendimiento!`;
                }
            } else if (q.includes('memoria') || q.includes('ram')) {
                if (stats.memory.percent > 85) {
                    response = `üö® Tu memoria RAM est√° casi llena (${stats.memory.percent.toFixed(1)}%). Cierra aplicaciones innecesarias y ejecuta la limpieza de memoria.`;
                } else if (stats.memory.percent > 70) {
                    response = `‚ö†Ô∏è Tu memoria RAM est√° al ${stats.memory.percent.toFixed(1)}%. Considera cerrar algunos programas para mejorar el rendimiento.`;
                } else {
                    response = `‚úÖ Tu memoria RAM est√° en buen estado (${stats.memory.percent.toFixed(1)}% de uso).`;
                }
            } else if (q.includes('disco') || q.includes('almacenamiento')) {
                if (stats.disk.percent > 90) {
                    response = `üö® ¬°Tu disco est√° casi lleno (${stats.disk.percent.toFixed(1)}%)! Te recomiendo ejecutar todas las optimizaciones de limpieza inmediatamente.`;
                } else if (stats.disk.percent > 75) {
                    response = `‚ö†Ô∏è Tu disco tiene ${stats.disk.percent.toFixed(1)}% de uso. Considera limpiar archivos temporales y la papelera de reciclaje.`;
                } else {
                    response = `‚úÖ Tu disco tiene buen espacio disponible (${(100 - stats.disk.percent).toFixed(1)}% libre).`;
                }
            } else if (q.includes('red') || q.includes('internet') || q.includes('conexi√≥n')) {
                response = `üì° Has enviado ${stats.network.sent} MB y recibido ${stats.network.recv} MB de datos. Si tienes problemas de conexi√≥n, verifica tu configuraci√≥n de red.`;
            } else if (q.includes('optimizar') || q.includes('mejorar')) {
                response = `üöÄ Para optimizar tu PC, te recomiendo ejecutar: limpieza de archivos temporales, desfragmentaci√≥n de disco, y limpieza de cache de navegadores. Tu CPU est√° al ${stats.cpu.percent.toFixed(1)}%, memoria al ${stats.memory.percent.toFixed(1)}%, y disco al ${stats.disk.percent.toFixed(1)}%.`;
            } else if (q.includes('procesos') || q.includes('programas')) {
                response = `üìã Tienes ${stats.processes} procesos activos corriendo. Si son muchos, considera cerrar aplicaciones innecesarias para mejorar el rendimiento.`;
            } else if (q.includes('ayuda') || q.includes('qu√© puedes') || q.includes('hacer')) {
                response = `ü§ñ ¬°Hola! Soy OptiBot, tu asistente de optimizaci√≥n. Puedo analizar el rendimiento de tu CPU, memoria, disco y red en tiempo real. Solo preg√∫ntame sobre cualquier componente de tu PC y te dar√© recomendaciones personalizadas. Tambi√©n puedo explicarte qu√© significan las estad√≠sticas que ves en los gr√°ficos.`;
            } else if (q.includes('gracias') || q.includes('thank')) {
                response = `üôÇ ¬°De nada! Estoy aqu√≠ para ayudarte a mantener tu PC funcionando al m√°ximo rendimiento. Si tienes m√°s preguntas sobre optimizaci√≥n, ¬°no dudes en preguntar!`;
            } else if (q.includes('hola') || q.includes('hi') || q.includes('hello')) {
                response = `üëã ¬°Hola! Soy OptiBot, tu asistente inteligente de optimizaci√≥n de PC. Estoy monitoreando tu sistema en tiempo real. ¬øEn qu√© puedo ayudarte hoy?`;
            } else {
                response = `ü§î No entend√≠ completamente tu pregunta. Puedo ayudarte con informaci√≥n sobre CPU, memoria RAM, disco duro, red, procesos activos, y recomendaciones de optimizaci√≥n. Tambi√©n puedo explicar cualquier estad√≠stica que veas en el dashboard. ¬°Prueba preguntarme algo espec√≠fico!`;
            }

            return response;
        }

        // Add AI message to chat
        function addAIMessage(message, isUser = false) {
            const chatContainer = document.getElementById('aiRecommendations');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${isUser ? 'ai-user' : 'ai-bot'}`;

            messageDiv.innerHTML = `
                <div class="ai-avatar">${isUser ? 'üë§' : 'ü§ñ'}</div>
                <div class="ai-content">
                    <strong>${isUser ? 'T√∫' : 'OptiBot'}:</strong> ${message}
                </div>
            `;

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            aiMessageCount++;

            // Limit messages to prevent overflow
            if (aiMessageCount > 10) {
                chatContainer.removeChild(chatContainer.firstChild);
                aiMessageCount--;
            }
        }

        // Generate AI recommendations based on stats
        function generateAIRecommendations(stats) {
            let recommendations = [];

            if (stats.cpu.percent > 80) {
                recommendations.push("üî• CPU muy alta: Cierra programas innecesarios");
            }

            if (stats.memory.percent > 85) {
                recommendations.push("üíæ Memoria baja: Libera RAM cerrando aplicaciones");
            }

            if (stats.disk.percent > 90) {
                recommendations.push("üíø Disco casi lleno: Ejecuta limpieza urgente");
            }

            if (stats.processes > 150) {
                recommendations.push("‚öôÔ∏è Muchos procesos: Revisa el administrador de tareas");
            }

            if (recommendations.length === 0) {
                recommendations.push("‚úÖ Tu sistema est√° funcionando bien");
                recommendations.push("üí° Recomiendo ejecutar optimizaciones preventivas semanalmente");
            }

            return recommendations;
        }

        // Ask AI function
        function askAI() {
            const input = document.getElementById('aiQuestion');
            const question = input.value.trim();

            if (!question) return;

            // Add user message
            addAIMessage(question, true);

            // Generate AI response
            const response = generateAIResponse(question, currentStats);

            // Add AI response with slight delay for natural feel
            setTimeout(() => {
                addAIMessage(response);
            }, 500);

            // Clear input
            input.value = '';
        }

        // Allow Enter key to send message
        document.getElementById('aiQuestion').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                askAI();
            }
        });

        // Update charts with new data
        function updateCharts(data) {
            currentStats = data; // Store for AI use
            const timestamp = new Date(data.timestamp * 1000).toLocaleTimeString();

            // CPU
            cpuData.push(data.cpu.percent);
            if (cpuData.length > maxDataPoints) cpuData.shift();
            cpuChart.data.labels = Array.from({length: cpuData.length}, (_, i) => i);
            cpuChart.data.datasets[0].data = cpuData;
            cpuChart.update();

            document.getElementById('cpuPercent').textContent = data.cpu.percent.toFixed(1) + '%';
            document.getElementById('cpuFreq').textContent = (data.cpu.freq_current / 1000).toFixed(2) + ' GHz';

            // Memory
            memoryChart.data.datasets[0].data = [data.memory.percent, 100 - data.memory.percent];
            memoryChart.update();

            document.getElementById('memoryUsed').textContent = data.memory.used + ' GB';
            document.getElementById('memoryTotal').textContent = data.memory.total + ' GB';

            // Disk
            diskChart.data.datasets[0].data = [data.disk.percent, 100 - data.disk.percent];
            diskChart.update();

            document.getElementById('diskUsed').textContent = data.disk.used + ' GB';
            document.getElementById('diskTotal').textContent = data.disk.total + ' GB';

            // Network
            if (networkData.length === 0) {
                networkData.push({sent: data.network.sent, recv: data.network.recv});
            } else {
                networkData.push({
                    sent: data.network.sent - networkData[networkData.length - 1].sent,
                    recv: data.network.recv - networkData[networkData.length - 1].recv
                });
            }
            if (networkData.length > maxDataPoints) networkData.shift();

            networkChart.data.labels = Array.from({length: networkData.length}, (_, i) => i);
            networkChart.data.datasets[0].data = networkData.map(d => d.sent);
            networkChart.data.datasets[1].data = networkData.map(d => d.recv);
            networkChart.update();

            document.getElementById('netSent').textContent = data.network.sent + ' MB';
            document.getElementById('netRecv').textContent = data.network.recv + ' MB';

            // System info
            document.getElementById('processCount').textContent = data.processes;

            // Update AI recommendations every few updates
            if (aiMessageCount === 1) { // Only initial message
                const recommendations = generateAIRecommendations(data);
                const recMessage = "üí° **Recomendaciones inteligentes:**<br>" + recommendations.join('<br>');
                document.querySelector('.ai-content').innerHTML = `<strong>OptiBot:</strong> ${recMessage}`;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();

            // Get system info once
            fetch('/api/system_stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('pythonVersion').textContent = '3.x';
                    document.getElementById('osVersion').textContent = navigator.platform;

                    // Calculate uptime (simplified)
                    const uptime = Math.floor(performance.now() / 1000 / 60 / 60);
                    document.getElementById('uptime').textContent = uptime + ' horas';
                });

            // Update every 2 seconds
            setInterval(fetchSystemStats, 2000);
        });
    </script>
</body>
</html>