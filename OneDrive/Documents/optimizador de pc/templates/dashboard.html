<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Optimizador de PC</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/animations.js') }}"></script>
</head>
<body>
    <div class="container">
        <h1>Dashboard de Rendimiento del Sistema</h1>
        <p>Monitoreo en tiempo real de los recursos del sistema</p>

        <div class="dashboard-grid">
            <!-- CPU Chart -->
            <div class="chart-card">
                <h3>CPU</h3>
                <div class="chart-container">
                    <canvas id="cpuChart"></canvas>
                </div>
                <div class="stats">
                    <span id="cpuPercent">0%</span>
                    <span id="cpuFreq">0 GHz</span>
                </div>
            </div>

            <!-- Memory Chart -->
            <div class="chart-card">
                <h3>Memoria RAM</h3>
                <div class="chart-container">
                    <canvas id="memoryChart"></canvas>
                </div>
                <div class="stats">
                    <span id="memoryUsed">0 GB</span> / <span id="memoryTotal">0 GB</span>
                </div>
            </div>

            <!-- Disk Chart -->
            <div class="chart-card">
                <h3>Disco Duro</h3>
                <div class="chart-container">
                    <canvas id="diskChart"></canvas>
                </div>
                <div class="stats">
                    <span id="diskUsed">0 GB</span> / <span id="diskTotal">0 GB</span>
                </div>
            </div>

            <!-- Network Chart -->
            <div class="chart-card">
                <h3>Red</h3>
                <div class="chart-container">
                    <canvas id="networkChart"></canvas>
                </div>
                <div class="stats">
                    <span id="netSent">0 MB</span> enviado<br>
                    <span id="netRecv">0 MB</span> recibido
                </div>
            </div>
        </div>

        <div class="system-info">
            <h3>Informaci√≥n del Sistema</h3>
            <div class="info-grid">
                <div class="info-item">
                    <strong>Procesos Activos:</strong> <span id="processCount">0</span>
                </div>
                <div class="info-item">
                    <strong>Tiempo de Actividad:</strong> <span id="uptime">0</span>
                </div>
                <div class="info-item">
                    <strong>Versi√≥n de Python:</strong> <span id="pythonVersion">-</span>
                </div>
                <div class="info-item">
                    <strong>Sistema Operativo:</strong> <span id="osVersion">-</span>
                </div>
            </div>
        </div>

        <!-- AI Assistant Section -->
        <div class="ai-assistant">
            <h3>ü§ñ Asistente IA - OptiBot</h3>
            <div class="ai-chat-container">
                <div class="ai-recommendations" id="aiRecommendations">
                    <div class="ai-message ai-bot">
                        <div class="ai-avatar">ü§ñ</div>
                        <div class="ai-content">
                            <strong>OptiBot:</strong> Analizando tu sistema... Espera las recomendaciones inteligentes.
                        </div>
                    </div>
                </div>
                <div class="ai-chat-input">
                    <input type="text" id="aiQuestion" placeholder="Preg√∫ntame sobre tu PC o el rendimiento..." />
                    <button onclick="askAI()">Preguntar</button>
                </div>
            </div>
        </div>

        <div class="dashboard-actions">
            <a href="/" class="btn-secondary">Volver al Optimizador</a>
            <button onclick="resetCharts()" class="btn-secondary">Reiniciar Gr√°ficos</button>
        </div>
    </div>

    <script>
        // Chart.js configurations
        let cpuChart, memoryChart, diskChart, networkChart;
        let cpuData = [], memoryData = [], diskData = [], networkData = [];
        const maxDataPoints = 20;

        // Initialize charts
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuart'
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#ecf0f1'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#ecf0f1'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#ecf0f1'
                        }
                    }
                }
            };

            // CPU Chart
            cpuChart = new Chart(document.getElementById('cpuChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU %',
                        data: cpuData,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            max: 100
                        }
                    }
                }
            });

            // Memory Chart
            memoryChart = new Chart(document.getElementById('memoryChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Usado', 'Libre'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#e74c3c', '#27ae60'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ecf0f1'
                            }
                        }
                    }
                }
            });

            // Disk Chart
            diskChart = new Chart(document.getElementById('diskChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Usado', 'Libre'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#f39c12', '#9b59b6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ecf0f1'
                            }
                        }
                    }
                }
            });

            // Network Chart
            networkChart = new Chart(document.getElementById('networkChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Enviado (MB)',
                        data: [],
                        borderColor: '#e67e22',
                        backgroundColor: 'rgba(230, 126, 34, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Recibido (MB)',
                        data: [],
                        borderColor: '#1abc9c',
                        backgroundColor: 'rgba(26, 188, 156, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });
        }

        // Update charts with new data
        function updateCharts(data) {
            const timestamp = new Date(data.timestamp * 1000).toLocaleTimeString();

            // CPU
            cpuData.push(data.cpu.percent);
            if (cpuData.length > maxDataPoints) cpuData.shift();
            cpuChart.data.labels = Array.from({length: cpuData.length}, (_, i) => i);
            cpuChart.data.datasets[0].data = cpuData;
            cpuChart.update();

            document.getElementById('cpuPercent').textContent = data.cpu.percent.toFixed(1) + '%';
            document.getElementById('cpuFreq').textContent = (data.cpu.freq_current / 1000).toFixed(2) + ' GHz';

            // Memory
            memoryChart.data.datasets[0].data = [data.memory.percent, 100 - data.memory.percent];
            memoryChart.update();

            document.getElementById('memoryUsed').textContent = data.memory.used + ' GB';
            document.getElementById('memoryTotal').textContent = data.memory.total + ' GB';

            // Disk
            diskChart.data.datasets[0].data = [data.disk.percent, 100 - data.disk.percent];
            diskChart.update();

            document.getElementById('diskUsed').textContent = data.disk.used + ' GB';
            document.getElementById('diskTotal').textContent = data.disk.total + ' GB';

            // Network
            if (networkData.length === 0) {
                networkData.push({sent: data.network.sent, recv: data.network.recv});
            } else {
                networkData.push({
                    sent: data.network.sent - networkData[networkData.length - 1].sent,
                    recv: data.network.recv - networkData[networkData.length - 1].recv
                });
            }
            if (networkData.length > maxDataPoints) networkData.shift();

            networkChart.data.labels = Array.from({length: networkData.length}, (_, i) => i);
            networkChart.data.datasets[0].data = networkData.map(d => d.sent);
            networkChart.data.datasets[1].data = networkData.map(d => d.recv);
            networkChart.update();

            document.getElementById('netSent').textContent = data.network.sent + ' MB';
            document.getElementById('netRecv').textContent = data.network.recv + ' MB';

            // System info
            document.getElementById('processCount').textContent = data.processes;
        }

        // Fetch system stats
        async function fetchSystemStats() {
            try {
                const response = await fetch('/api/system_stats');
                const data = await response.json();
                updateCharts(data);
            } catch (error) {
                console.error('Error fetching system stats:', error);
            }
        }

        // Reset charts
        function resetCharts() {
            cpuData.length = 0;
            memoryData.length = 0;
            diskData.length = 0;
            networkData.length = 0;

            cpuChart.data.labels = [];
            cpuChart.data.datasets[0].data = [];
            cpuChart.update();

            memoryChart.data.datasets[0].data = [0, 100];
            memoryChart.update();

            diskChart.data.datasets[0].data = [0, 100];
            diskChart.update();

            networkChart.data.labels = [];
            networkChart.data.datasets[0].data = [];
            networkChart.data.datasets[1].data = [];
            networkChart.update();
        }

        // AI Assistant Variables
        let currentStats = null;
        let aiMessageCount = 0;

        // AI Response function
        function generateAIResponse(question, stats) {
            const q = question.toLowerCase().trim();

            // An√°lisis inteligente basado en estad√≠sticas
            let response = '';

            // Palabras clave para cada componente
            const cpuKeywords = ['cpu', 'procesador', 'procesador central', 'microprocesador'];
            const memoryKeywords = ['memoria', 'ram', 'memoria ram', 'memoria principal'];
            const diskKeywords = ['disco', 'disco duro', 'almacenamiento', 'disco duro', 'ssd', 'hdd'];
            const networkKeywords = ['red', 'internet', 'conexi√≥n', 'wifi', 'redes'];
            const processKeywords = ['procesos', 'programas', 'aplicaciones', 'tareas'];
            const optimizeKeywords = ['optimizar', 'mejorar', 'optimizar pc', 'mejorar rendimiento', 'acelerar'];

            const hasKeyword = (keywords) => keywords.some(keyword => q.includes(keyword));

            if (hasKeyword(cpuKeywords)) {
                const usage = stats.cpu.percent;
                if (usage > 90) {
                    response = `üö® ¬°ALERTA CR√çTICA! Tu CPU est√° al ${usage.toFixed(1)}%, lo cual es extremadamente alto. Esto puede causar inestabilidad. Te recomiendo:\n‚Ä¢ Cerrar inmediatamente programas innecesarios\n‚Ä¢ Ejecutar optimizaci√≥n de procesos\n‚Ä¢ Revisar si hay malware\n‚Ä¢ Considerar reiniciar el sistema`;
                } else if (usage > 80) {
                    response = `‚ö†Ô∏è Tu CPU est√° muy alta al ${usage.toFixed(1)}%. Te recomiendo:\n‚Ä¢ Cerrar programas que no uses\n‚Ä¢ Ejecutar limpieza de archivos temporales\n‚Ä¢ Desactivar programas de inicio innecesarios`;
                } else if (usage > 60) {
                    response = `üìä Tu CPU est√° al ${usage.toFixed(1)}%, funcionando con carga moderada. Si notas lentitud:\n‚Ä¢ Limpia archivos temporales\n‚Ä¢ Verifica procesos en el administrador de tareas\n‚Ä¢ Considera actualizar controladores`;
                } else if (usage > 30) {
                    response = `‚úÖ Tu CPU est√° funcionando bien al ${usage.toFixed(1)}%. Rendimiento normal.`;
                } else {
                    response = `üåü ¬°Excelente! Tu CPU est√° pr√°cticamente inactiva al ${usage.toFixed(1)}%. Rendimiento √≥ptimo.`;
                }
            } else if (hasKeyword(memoryKeywords)) {
                const usage = stats.memory.percent;
                if (usage > 95) {
                    response = `üö® ¬°MEMORIA CR√çTICA! ${usage.toFixed(1)}% de uso. Riesgo de bloqueo inminente:\n‚Ä¢ Cierra TODOS los programas innecesarios\n‚Ä¢ Reinicia el navegador web\n‚Ä¢ Ejecuta limpieza de memoria inmediatamente\n‚Ä¢ Considera agregar m√°s RAM`;
                } else if (usage > 85) {
                    response = `‚ö†Ô∏è Memoria RAM casi llena (${usage.toFixed(1)}%). Acciones urgentes:\n‚Ä¢ Cierra aplicaciones que no uses\n‚Ä¢ Limpia cache del navegador\n‚Ä¢ Verifica procesos con alto consumo de memoria`;
                } else if (usage > 70) {
                    response = `üìä Memoria RAM con carga alta (${usage.toFixed(1)}%). Recomendaciones:\n‚Ä¢ Monitorea procesos en administrador de tareas\n‚Ä¢ Limpia archivos temporales\n‚Ä¢ Considera cerrar pesta√±as del navegador`;
                } else if (usage > 50) {
                    response = `‚úÖ Memoria RAM en buen estado (${usage.toFixed(1)}% de uso).`;
                } else {
                    response = `üåü ¬°Excelente uso de memoria! Solo ${usage.toFixed(1)}% utilizado.`;
                }
            } else if (hasKeyword(diskKeywords)) {
                const usage = stats.disk.percent;
                const freeGB = ((100 - usage) / 100 * stats.disk.total).toFixed(1);
                if (usage > 95) {
                    response = `üö® ¬°DISCO CR√çTICO! ${usage.toFixed(1)}% lleno. Solo quedan ${freeGB} GB libres:\n‚Ä¢ BORRA ARCHIVOS INNECESARIOS INMEDIATAMENTE\n‚Ä¢ Vac√≠a papelera de reciclaje\n‚Ä¢ Ejecuta limpieza de disco profunda\n‚Ä¢ Mueve archivos a disco externo`;
                } else if (usage > 90) {
                    response = `‚ö†Ô∏è Disco casi lleno (${usage.toFixed(1)}%, ${freeGB} GB libres). Acciones necesarias:\n‚Ä¢ Limpia archivos temporales\n‚Ä¢ Vac√≠a papelera de reciclaje\n‚Ä¢ Elimina programas no utilizados\n‚Ä¢ Mueve archivos grandes`;
                } else if (usage > 80) {
                    response = `üìä Disco con mucho uso (${usage.toFixed(1)}%, ${freeGB} GB libres). Recomendaciones:\n‚Ä¢ Ejecuta optimizaciones de limpieza\n‚Ä¢ Organiza archivos\n‚Ä¢ Considera desfragmentaci√≥n`;
                } else if (usage > 60) {
                    response = `‚úÖ Disco en buen estado (${usage.toFixed(1)}% usado, ${freeGB} GB libres).`;
                } else {
                    response = `üåü ¬°Excelente! Mucho espacio disponible (${(100 - usage).toFixed(1)}% libre, ${freeGB} GB).`;
                }
            } else if (hasKeyword(networkKeywords)) {
                const sent = stats.network.sent;
                const recv = stats.network.recv;
                response = `üì° Informaci√≥n de red:\n‚Ä¢ Datos enviados: ${sent} MB\n‚Ä¢ Datos recibidos: ${recv} MB\n‚Ä¢ Total transferido: ${(sent + recv).toFixed(1)} MB\n\nSi tienes problemas de conexi√≥n:\n‚Ä¢ Reinicia el router/m√≥dem\n‚Ä¢ Verifica configuraci√≥n de red\n‚Ä¢ Ejecuta diagn√≥stico de red\n‚Ä¢ Actualiza controladores de red`;
            } else if (hasKeyword(processKeywords)) {
                const count = stats.processes;
                if (count > 200) {
                    response = `üö® ¬°DEMASIADOS PROCESOS! ${count} procesos activos. Esto puede ralentizar tu PC:\n‚Ä¢ Cierra programas innecesarios\n‚Ä¢ Desactiva programas de inicio\n‚Ä¢ Revisa procesos en administrador de tareas\n‚Ä¢ Busca y elimina malware`;
                } else if (count > 150) {
                    response = `‚ö†Ô∏è Muchos procesos (${count}). Recomendaciones:\n‚Ä¢ Revisa administrador de tareas\n‚Ä¢ Desactiva programas de inicio innecesarios\n‚Ä¢ Limpia registro de Windows`;
                } else if (count > 100) {
                    response = `üìä N√∫mero moderado de procesos (${count}). Monitorea el rendimiento.`;
                } else {
                    response = `‚úÖ N√∫mero √≥ptimo de procesos (${count}). Excelente gesti√≥n del sistema.`;
                }
            } else if (hasKeyword(optimizeKeywords)) {
                const cpu = stats.cpu.percent;
                const mem = stats.memory.percent;
                const disk = stats.disk.percent;
                response = `üöÄ **PLAN DE OPTIMIZACI√ìN PERSONALIZADO**\n\nEstado actual:\n‚Ä¢ CPU: ${cpu.toFixed(1)}%\n‚Ä¢ Memoria: ${mem.toFixed(1)}%\n‚Ä¢ Disco: ${disk.toFixed(1)}%\n\n**Acciones recomendadas:**\n\n1. **Limpieza B√°sica**\n   ‚Ä¢ Archivos temporales\n   ‚Ä¢ Papelera de reciclaje\n   ‚Ä¢ Prefetch y archivos temporales\n\n2. **Optimizaciones Avanzadas**\n   ‚Ä¢ Desfragmentaci√≥n de disco\n   ‚Ä¢ Limpieza de cache de navegadores\n   ‚Ä¢ Actualizaci√≥n de Windows\n\n3. **Mantenimiento**\n   ‚Ä¢ Desactivar programas de inicio\n   ‚Ä¢ Actualizar controladores\n   ‚Ä¢ Escaneo de malware\n\n¬øQuieres que ejecute alguna optimizaci√≥n espec√≠fica?`;
            } else if (q.includes('ayuda') || q.includes('qu√© puedes') || q.includes('hacer') || q.includes('comandos')) {
                response = `ü§ñ **OPTI BOT - TU ASISTENTE DE OPTIMIZACI√ìN**\n\nPuedo ayudarte con:\n\nüìä **An√°lisis en Tiempo Real**\n‚Ä¢ CPU, Memoria, Disco, Red\n‚Ä¢ Procesos activos\n‚Ä¢ Rendimiento general\n\nüí° **Recomendaciones Inteligentes**\n‚Ä¢ Diagn√≥stico autom√°tico de problemas\n‚Ä¢ Planes de optimizaci√≥n personalizados\n‚Ä¢ Consejos preventivos\n\n‚ùì **Preguntas que puedo responder**\n‚Ä¢ "¬øC√≥mo est√° mi CPU?"\n‚Ä¢ "¬øQu√© optimizaciones recomiendas?"\n‚Ä¢ "¬øPor qu√© mi PC est√° lenta?"\n‚Ä¢ "¬øCu√°nta memoria estoy usando?"\n‚Ä¢ "¬øNecesito m√°s espacio?"\n\nüîß **Ejemplos de comandos**\n‚Ä¢ Preg√∫ntame sobre cualquier componente\n‚Ä¢ Pide recomendaciones espec√≠ficas\n‚Ä¢ Preg√∫ntame sobre el rendimiento\n\n¬°Solo escribe tu pregunta y te ayudar√©!`;
            } else if (q.includes('gracias') || q.includes('thank') || q.includes('merci')) {
                response = `üôÇ ¬°De nada! Estoy aqu√≠ 24/7 para mantener tu PC funcionando perfectamente. Si notas cualquier problema o tienes preguntas sobre optimizaci√≥n, ¬°no dudes en preguntarme!\n\n¬øHay algo m√°s en lo que pueda ayudarte?`;
            } else if (q.includes('hola') || q.includes('hi') || q.includes('hello') || q.includes('buenos') || q.includes('buenas')) {
                response = `üëã ¬°Hola! Soy **OptiBot**, tu asistente inteligente de optimizaci√≥n de PC.\n\nEstoy monitoreando constantemente tu sistema:\n‚Ä¢ CPU: ${stats.cpu.percent.toFixed(1)}%\n‚Ä¢ Memoria: ${stats.memory.percent.toFixed(1)}%\n‚Ä¢ Disco: ${stats.disk.percent.toFixed(1)}%\n‚Ä¢ Procesos: ${stats.processes}\n\n¬øEn qu√© puedo ayudarte hoy? Preg√∫ntame sobre el rendimiento de tu PC o pide recomendaciones de optimizaci√≥n.`;
            } else if (q.includes('problema') || q.includes('lenta') || q.includes('lento') || q.includes('error')) {
                response = `üîç **DIAGN√ìSTICO DE PROBLEMAS**\n\nEstado actual de tu PC:\n‚Ä¢ CPU: ${stats.cpu.percent.toFixed(1)}% ${stats.cpu.percent > 80 ? 'üî¥ ALTO' : stats.cpu.percent > 60 ? 'üü° MODERADO' : 'üü¢ BUENO'}\n‚Ä¢ Memoria: ${stats.memory.percent.toFixed(1)}% ${stats.memory.percent > 85 ? 'üî¥ CR√çTICO' : stats.memory.percent > 70 ? 'üü° ALTO' : 'üü¢ BUENO'}\n‚Ä¢ Disco: ${stats.disk.percent.toFixed(1)}% ${stats.disk.percent > 90 ? 'üî¥ LLENO' : stats.disk.percent > 75 ? 'üü° CASI LLENO' : 'üü¢ BUENO'}\n‚Ä¢ Procesos: ${stats.processes} ${stats.processes > 150 ? 'üî¥ DEMASIADOS' : stats.processes > 100 ? 'üü° MODERADOS' : 'üü¢ √ìPTIMO'}\n\n**Posibles causas de lentitud:**\n‚Ä¢ Alto uso de CPU por programas pesados\n‚Ä¢ Memoria insuficiente para multitasking\n‚Ä¢ Disco duro fragmentado o casi lleno\n‚Ä¢ Muchos procesos ejecut√°ndose\n‚Ä¢ Malware o virus\n‚Ä¢ Controladores desactualizados\n\n**Soluciones recomendadas:**\n1. Ejecuta optimizaciones completas\n2. Cierra programas innecesarios\n3. Limpia disco y memoria\n4. Actualiza software y controladores\n5. Escanea por malware\n\n¬øQuieres que ejecute alguna optimizaci√≥n espec√≠fica?`;
            } else if (q.includes('velocidad') || q.includes('rendimiento') || q.includes('performance')) {
                response = `‚ö° **AN√ÅLISIS DE RENDIMIENTO**\n\nTu PC est√° funcionando:\n\n**CPU:** ${stats.cpu.percent.toFixed(1)}% de uso\n‚Ä¢ Frecuencia: ${stats.cpu.freq_current.toFixed(0)} MHz\n‚Ä¢ ${stats.cpu.percent < 50 ? 'Excelente rendimiento' : stats.cpu.percent < 80 ? 'Buen rendimiento' : 'Rendimiento limitado'}\n\n**Memoria:** ${stats.memory.percent.toFixed(1)}% utilizada\n‚Ä¢ ${stats.memory.used.toFixed(1)} GB de ${stats.memory.total.toFixed(1)} GB\n‚Ä¢ ${stats.memory.percent < 70 ? 'Buena capacidad de memoria' : 'Memoria limitada'}\n\n**Disco:** ${stats.disk.percent.toFixed(1)}% utilizado\n‚Ä¢ ${stats.disk.used.toFixed(1)} GB de ${stats.disk.total.toFixed(1)} GB libres\n‚Ä¢ Velocidad: ${stats.disk.percent < 80 ? 'Buena velocidad de acceso' : 'Acceso limitado por espacio'}\n\n**Recomendaciones para mejorar velocidad:**\n‚Ä¢ Mant√©n CPU por debajo del 70%\n‚Ä¢ Libera al menos 30% de memoria\n‚Ä¢ Mant√©n disco por debajo del 80%\n‚Ä¢ Ejecuta mantenimiento semanal\n‚Ä¢ Actualiza hardware si es necesario\n\n¬øTe gustar√≠a ver recomendaciones espec√≠ficas?`;
            } else {
                // Respuesta gen√©rica pero √∫til
                response = `ü§î **${question}**\n\nNo entend√≠ completamente tu pregunta, pero puedo analizar tu sistema:\n\nüìä **Estado Actual:**\n‚Ä¢ CPU: ${stats.cpu.percent.toFixed(1)}%\n‚Ä¢ Memoria: ${stats.memory.percent.toFixed(1)}%\n‚Ä¢ Disco: ${stats.disk.percent.toFixed(1)}%\n‚Ä¢ Procesos: ${stats.processes}\n\nüí° **Puedo ayudarte con:**\n‚Ä¢ An√°lisis detallado de cualquier componente\n‚Ä¢ Recomendaciones de optimizaci√≥n\n‚Ä¢ Diagn√≥stico de problemas de rendimiento\n‚Ä¢ Consejos para mejorar velocidad\n\n**Prueba preguntando:**\n‚Ä¢ "¬øC√≥mo est√° mi CPU?"\n‚Ä¢ "¬øQu√© optimizaciones recomiendas?"\n‚Ä¢ "¬øPor qu√© mi PC est√° lenta?"\n‚Ä¢ "¬øC√≥mo mejorar el rendimiento?"\n\n¬°Solo dime qu√© necesitas saber!`;
            }

            return response;
        }

        // Add AI message to chat
        function addAIMessage(message, isUser = false) {
            const chatContainer = document.getElementById('aiRecommendations');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${isUser ? 'ai-user' : 'ai-bot'}`;

            messageDiv.innerHTML = `
                <div class="ai-avatar">${isUser ? 'üë§' : 'ü§ñ'}</div>
                <div class="ai-content">
                    <strong>${isUser ? 'T√∫' : 'OptiBot'}:</strong> ${message}
                </div>
            `;

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            aiMessageCount++;

            // Limit messages to prevent overflow
            if (aiMessageCount > 10) {
                chatContainer.removeChild(chatContainer.firstChild);
                aiMessageCount--;
            }
        }

        // Generate AI recommendations based on stats
        function generateAIRecommendations(stats) {
            let recommendations = [];

            if (stats.cpu.percent > 80) {
                recommendations.push("üî• CPU muy alta: Cierra programas innecesarios");
            }

            if (stats.memory.percent > 85) {
                recommendations.push("üíæ Memoria baja: Libera RAM cerrando aplicaciones");
            }

            if (stats.disk.percent > 90) {
                recommendations.push("üíø Disco casi lleno: Ejecuta limpieza urgente");
            }

            if (stats.processes > 150) {
                recommendations.push("‚öôÔ∏è Muchos procesos: Revisa el administrador de tareas");
            }

            if (recommendations.length === 0) {
                recommendations.push("‚úÖ Tu sistema est√° funcionando bien");
                recommendations.push("üí° Recomiendo ejecutar optimizaciones preventivas semanalmente");
            }

            return recommendations;
        }

        // Ask AI function
        function askAI() {
            const input = document.getElementById('aiQuestion');
            const question = input.value.trim();

            if (!question) return;

            // Add user message
            addAIMessage(question, true);

            // Generate AI response
            const response = generateAIResponse(question, currentStats);

            // Add AI response with slight delay for natural feel
            setTimeout(() => {
                addAIMessage(response);
            }, 500);

            // Clear input
            input.value = '';
        }

        // Allow Enter key to send message
        document.getElementById('aiQuestion').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                askAI();
            }
        });

        // Update charts with new data
        function updateCharts(data) {
            currentStats = data; // Store for AI use
            const timestamp = new Date(data.timestamp * 1000).toLocaleTimeString();

            // CPU
            cpuData.push(data.cpu.percent);
            if (cpuData.length > maxDataPoints) cpuData.shift();
            cpuChart.data.labels = Array.from({length: cpuData.length}, (_, i) => i);
            cpuChart.data.datasets[0].data = cpuData;
            cpuChart.update();

            document.getElementById('cpuPercent').textContent = data.cpu.percent.toFixed(1) + '%';
            document.getElementById('cpuFreq').textContent = (data.cpu.freq_current / 1000).toFixed(2) + ' GHz';

            // Memory
            memoryChart.data.datasets[0].data = [data.memory.percent, 100 - data.memory.percent];
            memoryChart.update();

            document.getElementById('memoryUsed').textContent = data.memory.used + ' GB';
            document.getElementById('memoryTotal').textContent = data.memory.total + ' GB';

            // Disk
            diskChart.data.datasets[0].data = [data.disk.percent, 100 - data.disk.percent];
            diskChart.update();

            document.getElementById('diskUsed').textContent = data.disk.used + ' GB';
            document.getElementById('diskTotal').textContent = data.disk.total + ' GB';

            // Network
            if (networkData.length === 0) {
                networkData.push({sent: data.network.sent, recv: data.network.recv});
            } else {
                networkData.push({
                    sent: data.network.sent - networkData[networkData.length - 1].sent,
                    recv: data.network.recv - networkData[networkData.length - 1].recv
                });
            }
            if (networkData.length > maxDataPoints) networkData.shift();

            networkChart.data.labels = Array.from({length: networkData.length}, (_, i) => i);
            networkChart.data.datasets[0].data = networkData.map(d => d.sent);
            networkChart.data.datasets[1].data = networkData.map(d => d.recv);
            networkChart.update();

            document.getElementById('netSent').textContent = data.network.sent + ' MB';
            document.getElementById('netRecv').textContent = data.network.recv + ' MB';

            // System info
            document.getElementById('processCount').textContent = data.processes;

            // Update AI recommendations every few updates
            if (aiMessageCount === 1) { // Only initial message
                const recommendations = generateAIRecommendations(data);
                const recMessage = "üí° **Recomendaciones inteligentes:**<br>" + recommendations.join('<br>');
                document.querySelector('.ai-content').innerHTML = `<strong>OptiBot:</strong> ${recMessage}`;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();

            // Get system info once
            fetch('/api/system_stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('pythonVersion').textContent = '3.x';
                    document.getElementById('osVersion').textContent = navigator.platform;

                    // Calculate uptime (simplified)
                    const uptime = Math.floor(performance.now() / 1000 / 60 / 60);
                    document.getElementById('uptime').textContent = uptime + ' horas';
                });

            // Update every 2 seconds
            setInterval(fetchSystemStats, 2000);
        });
    </script>
</body>
</html>